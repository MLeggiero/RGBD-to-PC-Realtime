/rtabmap:
  ros__parameters:
    # Database Settings
    database_path: '~/.ros/rtabmap.db'

    # Frame IDs
    frame_id: 'camera_link'
    odom_frame_id: 'odom'
    map_frame_id: 'map'

    # Subscribe to topics
    subscribe_depth: true
    subscribe_rgb: true
    subscribe_scan: false  # No 2D laser scan
    subscribe_scan_cloud: false

    # Approx sync for Raspberry Pi (more forgiving timing)
    approx_sync: true
    approx_sync_max_interval: 0.1  # 100ms tolerance

    # Queue size
    queue_size: 10

    # Processing frequency (Hz) - Reduced for Raspberry Pi
    detection_rate: 1.0  # Process 1 frame per second for mapping

    # Memory management for Raspberry Pi
    Mem/IncrementalMemory: 'true'
    Mem/InitWMWithAllNodes: 'false'

    # RTAB-Map Strategy
    RGBD/Enabled: 'true'
    RGBD/LinearUpdate: '0.1'      # Minimum 10cm movement to add keyframe
    RGBD/AngularUpdate: '0.1'     # Minimum ~6 degree rotation to add keyframe
    RGBD/OptimizeFromGraphEnd: 'false'

    # Point cloud settings
    cloud_decimation: 2  # Reduce point cloud density (keep every 2nd point)
    cloud_max_depth: 4.0  # Maximum depth in meters (4m range)
    cloud_min_depth: 0.3  # Minimum depth in meters
    cloud_voxel_size: 0.01  # 1cm voxel grid for downsampling
    cloud_noise_filtering_radius: 0.05
    cloud_noise_filtering_min_neighbors: 5

    # Visual odometry
    Odom/Strategy: '0'  # 0=Frame-to-Map, 1=Frame-to-Frame
    Odom/ResetCountdown: '1'
    OdomF2M/MaxSize: '1000'

    # Feature detection (optimized for performance)
    Vis/FeatureType: '6'  # 6=GFTT/ORB (faster than SIFT/SURF)
    Vis/MaxFeatures: '400'  # Reduced for Raspberry Pi
    Vis/MinInliers: '15'

    # Loop closure detection
    RGBD/LoopClosureReextractFeatures: 'true'
    LccBow/MinInliers: '10'
    LccBow/InlierDistance: '0.1'
    Rtabmap/TimeThr: '0'  # No time limit for loop closure
    Mem/RehearsalSimilarity: '0.30'

    # Graph optimization
    RGBD/OptimizeMaxError: '3.0'
    Optimizer/Iterations: '10'  # Reduced iterations
    Optimizer/Epsilon: '0.00001'
    RGBD/ProximityBySpace: 'true'
    RGBD/ProximityMaxGraphDepth: '50'
    RGBD/ProximityPathMaxNeighbors: '10'

    # Mapping
    Grid/FromDepth: 'false'
    Grid/3D: 'true'  # Create 3D map
    Grid/MaxObstacleHeight: '2.5'  # Max height for obstacles (2.5m)
    Grid/MaxGroundHeight: '0.1'   # Ground threshold
    Grid/CellSize: '0.05'  # 5cm cells

    # Visualization
    Rtabmap/PublishStats: 'true'
    Rtabmap/PublishRAMUsage: 'true'
    Rtabmap/PublishLikelihood: 'true'

    # Performance tuning for Raspberry Pi
    Rtabmap/DetectionRate: '1.0'  # Hz - process 1 frame/sec
    Rtabmap/MaxRetrieved: '2'  # Max memories retrieved for loop closure
    Rtabmap/MemoryThr: '50'  # Memory threshold (0-100, lower = keep more)

    # Output publishing
    publish_tf: 'true'
    gen_cloud: 'true'  # Generate assembled point cloud
    gen_octomap: 'false'  # Disable octomap to save resources
